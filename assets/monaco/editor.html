<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphviz DOT Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1e1e1e;
        }
        #editor-container {
            width: 100%;
            height: 100%;
        }
        /* Hide scrollbar fighting with Qt */
        .monaco-editor .overflow-guard {
            width: 100% !important;
        }
    </style>
</head>
<body>
    <div id="editor-container"></div>

    <!-- QWebChannel for C++ communication -->
    <script src="qrc:/monaco/qwebchannel.js"></script>
    
    <!-- Monaco loader (AMD-style) -->
    <script src="qrc:/monaco/monaco-loader.js"></script>
    
    <!-- DOT/Graphviz language definition -->
    <script src="qrc:/monaco/dot-language.js"></script>

    <script>
        // ===== Global State =====
        let editor = null;
        let bridge = null;
        let isUpdatingFromCpp = false;  // Guard against recursive updates

        // ===== Initialize QWebChannel =====
        function initWebChannel() {
            return new Promise((resolve, reject) => {
                if (typeof QWebChannel === 'undefined') {
                    reject(new Error('QWebChannel not available'));
                    return;
                }
                
                new QWebChannel(qt.webChannelTransport, function(channel) {
                    bridge = channel.objects.bridge;
                    if (bridge) {
                        // Connect to C++ signals - these update editor FROM C++
                        bridge.requestSetText.connect(function(text) {
                            if (editor && !isUpdatingFromCpp) {
                                isUpdatingFromCpp = true;
                                const currentText = editor.getValue();
                                // Only update if text is actually different
                                if (currentText !== text) {
                                    editor.setValue(text);
                                }
                                isUpdatingFromCpp = false;
                            }
                        });
                        
                        bridge.requestSetLanguage.connect(function(language) {
                            if (editor) {
                                monaco.editor.setModelLanguage(editor.getModel(), language);
                            }
                        });
                        
                        bridge.requestSetReadOnly.connect(function(readOnly) {
                            if (editor) {
                                editor.updateOptions({ readOnly: readOnly });
                            }
                        });
                        
                        resolve(bridge);
                    } else {
                        reject(new Error('Bridge not found'));
                    }
                });
            });
        }

        // ===== Initialize Monaco Editor =====
        function initMonaco() {
            return new Promise((resolve) => {
                // 1. Define Strategient dark theme
                defineStrategientTheme();
                
                // 2. Register DOT/Graphviz language
                registerDotLanguage();
                
                // 3. Create editor with Strategient theme and DOT language
                editor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: '',
                    language: 'dot',  // Graphviz DOT language
                    theme: 'strategient-dark',
                    
                    // Layout
                    automaticLayout: true,
                    scrollBeyondLastLine: false,
                    
                    // Font
                    fontSize: 13,
                    fontFamily: "'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace",
                    fontLigatures: true,
                    
                    // Line numbers
                    lineNumbers: 'on',
                    lineNumbersMinChars: 3,
                    renderLineHighlight: 'line',
                    
                    // Minimap - disabled for cleaner look in dock
                    minimap: { enabled: false },
                    
                    // Scrollbar
                    scrollbar: {
                        vertical: 'auto',
                        horizontal: 'auto',
                        verticalScrollbarSize: 10,
                        horizontalScrollbarSize: 10
                    },
                    
                    // Editing
                    wordWrap: 'on',
                    tabSize: 2,
                    insertSpaces: true,
                    autoIndent: 'advanced',
                    formatOnPaste: false,
                    formatOnType: false,
                    
                    // Features
                    folding: true,
                    foldingStrategy: 'indentation',
                    showFoldingControls: 'mouseover',
                    bracketPairColorization: { enabled: true },
                    
                    // Suggestions
                    suggestOnTriggerCharacters: true,
                    quickSuggestions: {
                        other: true,
                        comments: false,
                        strings: false
                    },
                    acceptSuggestionOnEnter: 'on',
                    
                    // Cursor
                    cursorStyle: 'line',
                    cursorBlinking: 'smooth',
                    cursorSmoothCaretAnimation: 'on',
                    
                    // Selection
                    selectionHighlight: true,
                    occurrencesHighlight: true,
                    
                    // Other
                    renderWhitespace: 'selection',
                    guides: {
                        indentation: true,
                        bracketPairs: true
                    }
                });

                // 4. Listen for content changes - notify C++ ONLY when user edits
                editor.onDidChangeModelContent(function(event) {
                    // CRITICAL: Do not notify if we're updating from C++
                    // This prevents recursive render loops
                    if (!isUpdatingFromCpp && bridge) {
                        bridge.notifyTextChanged(editor.getValue());
                    }
                });

                // 5. Handle focus for better Qt integration
                editor.onDidFocusEditorText(function() {
                    document.body.classList.add('editor-focused');
                });
                
                editor.onDidBlurEditorText(function() {
                    document.body.classList.remove('editor-focused');
                });

                resolve(editor);
            });
        }

        // ===== Main Initialization =====
        async function init() {
            try {
                await initWebChannel();
                await initMonaco();
                
                // Notify C++ that editor is ready
                if (bridge) {
                    bridge.notifyEditorReady();
                }
                
                console.log('[Monaco] DOT/Graphviz editor initialized with Strategient theme');
            } catch (error) {
                console.error('[Monaco] Initialization error:', error);
            }
        }

        // Wait for Monaco to load, then initialize
        if (typeof monaco !== 'undefined') {
            init();
        } else {
            // Monaco loader will call monacoReady when loaded
            window.monacoReady = init;
        }
    </script>
</body>
</html>
